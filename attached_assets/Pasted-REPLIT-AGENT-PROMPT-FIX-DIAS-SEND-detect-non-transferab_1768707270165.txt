REPLIT AGENT PROMPT — FIX DIAS SEND: detect non-transferable / permanent delegate Token-2022 BEFORE signing + make the modal match Cordon theme

FOCUS ONLY ON THIS BUG:
When sending DIAS (Token-2022), the wallet should detect if the token is NON-TRANSFERABLE / only movable by a Permanent Delegate, and show the correct warning (or block sending) BEFORE signing. Also, the current popup/modal container style is not matching our Cordon theme (looks like a generic/native modal).

What we want (behavior):
1) If DIAS mint is Token-2022 and is NON-TRANSFERABLE:
   - BEFORE showing “Wallet Firewall – Before You Sign”, detect this and show a clear warning:
     “This token is non-transferable. Only the permanent delegate can transfer it.”
   - If the current active wallet IS NOT the permanent delegate address → block the transaction:
     - Disable “Confirm Send”
     - Or replace the confirm with a single “OK” and do not proceed to signing.

2) If DIAS mint is Token-2022 and has Permanent Delegate set (even if transferable):
   - Show an info line in the firewall modal:
     “Permanent delegate enabled: <short address>”
   - But do NOT call it “non-transferable” unless we detect the actual NonTransferable restriction.

3) Theme fix:
   - Do not use iOS native Alert/ActionSheet style for the firewall or error popup.
   - Use our existing themed modal/sheet component (the same look as other Cordon overlays):
     - background blur / dark overlay
     - rounded container
     - colors from theme (theme.backgroundCard, theme.text, theme.textSecondary, theme.danger, etc.)
     - consistent button style

IMPORTANT TECH NOTE (so we don’t mis-detect):
- “Permanent Delegate” by itself does NOT automatically mean holders can’t transfer.
- The “only permanent delegate can transfer” rule usually comes from Token-2022 extensions like:
  - NonTransferable (true non-transferable token)
  - OR TransferHook / custom restriction program that rejects normal transfers
So we must detect the actual restriction:
- If NonTransferable extension exists → definitely non-transferable for holders.
- If TransferHook exists → we can “simulate” or show warning “Transfer restrictions enabled”.
- If only PermanentDelegate exists → show info only (not a block).

-------------------------------------------------------------------------------
STEP 1) Locate the send confirmation modal + security assessment UI
-------------------------------------------------------------------------------
Search the codebase for these exact strings:
- "Wallet Firewall - Before You Sign"
- "Security Assessment"
- "Confirm Send"
- "Review Transaction"

Identify the component that builds the “Wallet Firewall – Before You Sign” popup.
We will modify that component so it accepts extra “restrictions” (nontransferable etc.)
AND we will ensure it is a themed modal (not Alert.alert).

-------------------------------------------------------------------------------
STEP 2) Add Token-2022 mint inspection helper (Solana)
-------------------------------------------------------------------------------
Create a helper in: client/lib/solana/token2022Guard.ts (new file)

Goal: given a mint address, fetch Token-2022 mint account, parse extensions, return flags:
- isToken2022 (bool)
- isNonTransferable (bool)
- hasPermanentDelegate (bool)
- permanentDelegate (string | null)
- hasTransferHook (bool)
- hasFreezeAuthority (bool) + freezeAuthority (string|null) (optional)
- hasTransferFee (bool) (optional)

Implementation details:
- Use TOKEN_2022_PROGRAM_ID for Token-2022 mint fetch.
- Fetch mint account info and parse TLV extensions.
- Use @solana/spl-token (new versions support token-2022 parsing). If your current version is older,
  fall back to manual TLV parse, but try spl-token first.

Pseudocode (adjust to your installed lib version):
- import { Connection, PublicKey } from "@solana/web3.js";
- import {
    TOKEN_2022_PROGRAM_ID,
    unpackMint,
    getExtensionTypes,
    ExtensionType,
    getExtensionData,
  } from "@solana/spl-token";

async function inspectToken2022Mint(connection: Connection, mint: string) {
  const mintPk = new PublicKey(mint);
  const info = await connection.getAccountInfo(mintPk, "confirmed");
  if (!info) return { isToken2022: false };

  // Verify owner == TOKEN_2022_PROGRAM_ID
  const isToken2022 = info.owner.equals(TOKEN_2022_PROGRAM_ID);
  if (!isToken2022) return { isToken2022: false };

  const parsed = unpackMint(mintPk, info, TOKEN_2022_PROGRAM_ID);
  // parsed.tlvData holds extensions
  const extTypes = getExtensionTypes(parsed.tlvData);

  const isNonTransferable = extTypes.includes(ExtensionType.NonTransferable);
  const hasPermanentDelegate = extTypes.includes(ExtensionType.PermanentDelegate);
  let permanentDelegate: string | null = null;

  if (hasPermanentDelegate) {
    const pd = getExtensionData(ExtensionType.PermanentDelegate, parsed.tlvData);
    // parse pd to read delegate pubkey (depends on library helper; if helper exists, use it)
    // permanentDelegate = new PublicKey(pd.delegate).toBase58();
  }

  const hasTransferHook = extTypes.includes(ExtensionType.TransferHook);
  const hasFreezeAuthority = !!parsed.freezeAuthority; // if exposed

  return {
    isToken2022: true,
    isNonTransferable,
    hasPermanentDelegate,
    permanentDelegate,
    hasTransferHook,
    hasFreezeAuthority,
  };
}

If your spl-token build does not expose getExtensionTypes/getExtensionData,
log parsed / tlvData and implement a minimal TLV type-scan just to detect NonTransferable + PermanentDelegate + TransferHook.
(We only need detection, not full decode, except permanentDelegate address.)

-------------------------------------------------------------------------------
STEP 3) Enforce the rule BEFORE signing (send flow)
-------------------------------------------------------------------------------
In the send screen flow (where "Review Transaction" or "Confirm Send" is triggered):
- Right before opening the “Wallet Firewall – Before You Sign” modal,
  call inspectToken2022Mint(connection, mintAddress).

Decision:
A) If isToken2022 && isNonTransferable === true:
   - If permanentDelegate exists AND activeWalletAddress === permanentDelegate:
       allow sending BUT show prominent warning:
         Title: “Non-transferable token (delegate only)”
         Body: “This token can only be transferred by the permanent delegate. You are the delegate.”
   - Else:
       BLOCK sending:
         Title: “Cannot Send — Non-transferable Token”
         Body: “This token is non-transferable. Only the permanent delegate can move it.”
       Provide only an “OK” button, no “Confirm Send”.

B) Else if isToken2022 && hasTransferHook === true:
   - Don’t block automatically.
   - Show warning line in firewall modal:
     “Transfer restrictions enabled (Token-2022). Some transfers may fail.”

C) Else if isToken2022 && hasPermanentDelegate === true:
   - Show info line (not “High Risk”):
     “Permanent delegate enabled: <short address>”

Also:
- Update “Security Assessment” sheet (the one showing Freeze Authority etc.)
  to include:
  - If NonTransferable: show a red “Non-transferable” item at top with explanation.
  - If PermanentDelegate: show “Permanent delegate enabled” as “Info”.

-------------------------------------------------------------------------------
STEP 4) Fix the popup container theme (no native Alert)
-------------------------------------------------------------------------------
Replace any Alert.alert / ActionSheet / default iOS modal used for:
- “Wallet Firewall – Before You Sign”
- “Insufficient SOL for Fees”
with a shared themed modal component.

Create (or reuse) something like:
- client/components/ThemedModal.tsx
or if you already have a BottomSheet component, reuse it.

Themed modal requirements:
- Container background: theme.backgroundCard (or similar)
- Rounded corners: 24
- Backdrop: semi-transparent dark overlay + optional blur
- Text: theme.text / theme.textSecondary
- Danger badge: theme.danger
- Buttons: match existing Cordon Button styles

Implement the firewall modal using this ThemedModal:
- Show transaction summary
- Show “Restriction banners” section:
  - Non-transferable banner (danger)
  - TransferHook banner (warning)
  - Permanent delegate banner (info)
- If blocked: show only one button “OK”
- If allowed: show “Cancel” + “Confirm Send”

-------------------------------------------------------------------------------
STEP 5) Make sure the warning shown is correct for DIAS
-------------------------------------------------------------------------------
DIAS (Roachy Diamond) is in-game currency and not exchange-listed — we don’t need to mention exchanges.
We DO need to mention transfer restriction if detected:
- “Non-transferable token: holders cannot transfer. Only permanent delegate can move it.”
If you can detect PermanentDelegate address:
- Show it shortened: ABCD...WXYZ

-------------------------------------------------------------------------------
ACCEPTANCE TEST (do this after implementation):
1) Try to send DIAS from a normal holder wallet:
   - Before signing, you should see:
     “Cannot Send — Non-transferable Token”
     with ONLY OK, and no signing happens.
2) Try to send DIAS from the permanent delegate wallet:
   - It should allow and show a warning banner:
     “Non-transferable token (delegate only) — You are the delegate.”
3) Confirm the modal UI looks like Cordon theme (not iOS native alert).
4) “Security Assessment” sheet also reflects “Non-transferable” instead of generic “Freeze Authority” message when applicable.

Deliverables:
- New helper: client/lib/solana/token2022Guard.ts
- Updated send flow component (where “Review Transaction” opens firewall modal)
- Updated firewall modal component to display restriction banners + block send when needed
- Updated Security Assessment sheet to show NonTransferable / PermanentDelegate info
- Remove native Alert usage for these popups and replace with themed modal