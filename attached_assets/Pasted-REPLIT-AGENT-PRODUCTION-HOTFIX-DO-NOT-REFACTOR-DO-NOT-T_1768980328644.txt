REPLIT AGENT — PRODUCTION HOTFIX (DO NOT REFACTOR, DO NOT TOUCH UNRELATED FILES)

Goal:
1) Stop showing “Connecting to dApp…” on every page (it should ONLY show after user actually selects WalletConnect OR a WC URI is detected).
2) Capture WalletConnect URI faster by intercepting Storage.setItem and common deep link params.
3) Keep existing behavior as much as possible; only surgical edits.

ONLY EDIT THESE FILES:
- client/screens/BrowserWebViewScreen.tsx  (where WALLETCONNECT_CAPTURE_SCRIPT lives and where WebView onMessage handlers are)
No other files.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
A) FIX: Stop WC_BUTTON_CLICKED spam (root cause of loader always showing)
In WALLETCONNECT_CAPTURE_SCRIPT inside BrowserWebViewScreen.tsx:

1) FIND the “Other wallet-related button clicks” block near the end:

// Other wallet-related button clicks
if (text.includes('wallet') || text.includes('connect') ||
className.includes('wallet') || className.includes('connect') || className.includes('w3m') || className.includes('wcm')) {
  console.log('[Cordon] Wallet button clicked');
  setTimeout(function() { deepScanForWcUri(); }, 200);
  setTimeout(function() { deepScanForWcUri(); }, 800);
  setTimeout(function() { deepScanForWcUri(); }, 1500);
}

DELETE this entire block completely.

Reason: it fires on random UI (“connect”, “select token”, etc.) causing loader spam.

2) KEEP the “WalletConnect clicked” block, but tighten it:
Inside the “isWcButton” detection, replace the condition:

if (pText === 'walletconnect' || (pText.includes('walletconnect') && pText.length < 50) ||
pClass.includes('walletconnect') || hasWcImg)

WITH this stricter condition:

if (
  (pText && pText.trim() === 'walletconnect') ||
  (pText && pText.trim().startsWith('walletconnect')) ||
  (pClass && pClass.includes('walletconnect')) ||
  !!hasWcImg
)

And inside that block: KEEP posting WC_BUTTON_CLICKED (this is the ONLY time we want to show loader).

3) Add a new message event ONLY when a wallet modal opens (for fast scanning, but NOT loader):
In the MutationObserver “Modal detected” area, right after:
console.log('[Cordon] Modal detected:', tagName);

ADD:
if (window.ReactNativeWebView) {
  window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'WC_MODAL_OPENED' }));
}

But DO NOT show loader from this event on native side.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
B) SPEED: Capture URI immediately when stored (missing piece)
Still inside WALLETCONNECT_CAPTURE_SCRIPT, ADD these hooks near the top (after scanStorage/extractWcFromText helpers, before MutationObserver is fine):

1) Intercept Storage.setItem globally (covers localStorage + sessionStorage):
Add:

function hookStorageSetItem() {
  try {
    var orig = Storage.prototype.setItem;
    Storage.prototype.setItem = function(k, v) {
      try {
        if (typeof v === 'string') {
          var wc = extractWcFromText(v);
          if (wc) postWc(wc);
        }
      } catch (e) {}
      return orig.apply(this, arguments);
    };
  } catch (e) {}
}
hookStorageSetItem();

2) Also listen to “storage” events (some libs trigger it):
try {
  window.addEventListener('storage', function(ev) {
    try {
      if (ev && ev.newValue && typeof ev.newValue === 'string') {
        var wc = extractWcFromText(ev.newValue);
        if (wc) postWc(wc);
      }
    } catch (e) {}
  });
} catch (e) {}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
C) CAPTURE: Handle WalletConnect deep link URLs (some dApps use walletconnect://wc?uri=...)
Your window.open hook already checks wc= / uri=.
Extend it to cover “walletconnect://wc” and “wc?uri=”.

Inside window.open hook, after:
if (url.includes('wc=') || url.includes('uri=')) {

Change it to:
if (url.includes('wc=') || url.includes('uri=') || url.startsWith('walletconnect://') || url.includes('walletconnect://wc')) {

And when parsing URL params, check both:
- uri
- wc
- request
Add:
var wcParam = u.searchParams.get('uri') || u.searchParams.get('wc') || u.searchParams.get('request');

Then decode and extractWcFromText like you already do.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
D) NATIVE SIDE: Loader should only show for real WalletConnect flow
In BrowserWebViewScreen.tsx onMessage handler (handleWebViewMessage), ensure:

1) When receiving { type: "WC_BUTTON_CLICKED" }:
- setIsWcConnecting(true)
- start 8s timeout to auto-hide (you already have this)

2) When receiving { type: "WC_URI" }:
- setIsWcConnecting(false) immediately BEFORE pairing
- then call handleWalletConnectUri(uri)

3) When receiving { type: "WC_MODAL_OPENED" }:
- DO NOT show loader
- just trigger a quick deep scan by sending no UI change (optional log only)

4) IMPORTANT: On navigation changes, always clear the loader:
In handleNavigationStateChange OR onLoadStart:
- setIsWcConnecting(false)
- clear wcConnectTimeout.current if exists

This prevents the loader persisting when user navigates away.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
E) TEST CHECKLIST (DO NOT SKIP)
1) Open app.uniswap.org in in-app browser.
2) Confirm: Loader does NOT appear on home page automatically.
3) Tap “Connect wallet” -> wallet list opens -> STILL no loader yet.
4) Tap “WalletConnect” option -> loader appears immediately.
5) Within ~0-1s, URI should be captured via Storage.setItem hook and native pairing starts.
6) Loader hides as soon as URI is received.
7) If URI never arrives, loader auto-hides after 8s.

DELIVERABLE:
- Commit only the changes above.
- Do not change formatting outside edited blocks.
- Do not rename functions.
- Do not refactor or reorder code.