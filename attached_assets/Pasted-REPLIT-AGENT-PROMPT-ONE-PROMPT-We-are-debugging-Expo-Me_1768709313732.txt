REPLIT AGENT PROMPT (ONE PROMPT)

We are debugging Expo + Metro Web preview blank screen. Browser console first error: "ReferenceError: Can't find variable: Buffer".
Our previous attempt using metro.config.js serializer.getPolyfills injection is NOT working for web (global.js not executed early).
Fix it by injecting the shim using Metro's getModulesRunBeforeMainModule (works for web), and ensure Buffer/process are set on globalThis BEFORE any deps evaluate.

1) Create/replace root-level global.js with this exact content:

// global.js
import "react-native-get-random-values";
import { Buffer } from "buffer";
import process from "process";

// IMPORTANT: use globalThis (works on web + native)
if (!globalThis.Buffer) globalThis.Buffer = Buffer;
if (!globalThis.process) globalThis.process = process;
globalThis.process.env = globalThis.process.env || {};

// Debug proof it runs first
console.log("[global.js] injected. Buffer?", !!globalThis.Buffer);

2) Update/replace root metro.config.js using expo/metro-config and inject global.js as a module run BEFORE main:

// metro.config.js
const { getDefaultConfig } = require("expo/metro-config");

const config = getDefaultConfig(__dirname);

// Ensure buffer/process resolve correctly
config.resolver.extraNodeModules = {
  ...(config.resolver.extraNodeModules || {}),
  buffer: require.resolve("buffer/"),
  process: require.resolve("process/"),
};

// CRITICAL: run our shim before the app entry on ALL platforms including web
const prev = config.serializer.getModulesRunBeforeMainModule;
config.serializer.getModulesRunBeforeMainModule = () => {
  const prevList = prev ? prev() : [];
  return [require.resolve("./global.js"), ...prevList];
};

module.exports = config;

3) Ensure app.json (or app.config.js) has expo.web.bundler set to metro:
"web": { "bundler": "metro" }

4) Ensure dependencies exist:
- buffer
- process
- react-native-get-random-values
If missing, add them.

5) Hard reset + verify:
- Stop dev server
- Run: npx expo start --web --clear
- Open web preview and confirm console shows:
  [global.js] injected. Buffer? true
and Buffer error is gone.

6) If Buffer error persists, it means Metro isn't using our metro.config.js.
Then:
- Confirm metro.config.js is at project root (same level as package.json)
- Confirm Expo is actually using Metro bundler for web (not webpack)
- Print a log from metro.config.js to verify it's loaded:
  console.log("[metro.config] loaded");
If it’s not printing, fix the path/structure so Metro loads it.

Deliver back:
- final global.js
- final metro.config.js
- confirmation log lines from web console/terminal
- any follow-up missing-module errors after Buffer is fixed (don’t guess polyfills; report exact error)