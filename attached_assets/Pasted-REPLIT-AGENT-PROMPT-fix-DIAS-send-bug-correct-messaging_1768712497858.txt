REPLIT AGENT PROMPT (fix DIAS send bug + correct messaging + themed modal)

Goal:
When sending DIAS (Solana Token-2022 w/ transfer restrictions), Cordon must detect “non-transferable / only permanent delegate can transfer” and show the correct warning + block send BEFORE signing. Right now it incorrectly shows “Insufficient SOL for Fees” even when SOL exists. Also the “Insufficient SOL” popup styling must match our theme (no default iOS Alert look).

What to change (do NOT refactor unrelated logic):

A) Find the exact send flow + where the wrong message is thrown
1) Search the codebase for the literal string:
   "Insufficient SOL for Fees"
   or "recipient's token account"
   or "need SOL in your wallet"
2) Identify which screen/service triggers it (likely Send screen or Solana send service).
   You must capture:
   - file path(s)
   - function name(s)
   - the catch/error mapping currently used

B) Implement Token-2022 transferability detection (preflight)
We need a guard BEFORE creating/sending the transaction:
- If the mint is Token-2022 AND has NonTransferable extension OR has PermanentDelegate set AND the active wallet is NOT the permanent delegate => show a clear non-transferable warning and disable sending.

Implementation details:
1) Create a helper in a new file:
   client/lib/solana/token2022-transferability.ts

It should export something like:
- getMintTransferRules(connection, mintPubkey): returns:
  {
    program: "token" | "token2022",
    isNonTransferable: boolean,
    permanentDelegate?: string | null,
    freezeAuthority?: string | null,
    transferFeeEnabled?: boolean,
    // optional: rawExtensions for debugging
  }

How:
- Fetch mint account info (connection.getAccountInfo(mint))
- Detect which program owns it:
  - TOKEN_PROGRAM_ID vs TOKEN_2022_PROGRAM_ID
- If TOKEN_2022_PROGRAM_ID:
  - parse mint + extensions using @solana/spl-token (token-2022 helpers)
  - detect NonTransferable extension
  - detect PermanentDelegate extension + value
  - (bonus: keep existing checks for freeze + transfer fee, but that’s optional)

2) In the Solana send flow (the function that handles “Review Transaction” / “Confirm Send”):
- Call getMintTransferRules() for the selected asset mint
- If isNonTransferable === true:
  - block send immediately with a themed modal:
    Title: “Token can’t be transferred”
    Body: “This token is non-transferable (Token-2022). Only the issuer / permanent delegate can move it. You can still use it inside the game.”
  - Do NOT proceed to build/sign/send the tx
- Else if permanentDelegate exists AND active wallet pubkey !== permanentDelegate:
  - block send with:
    Title: “Transfers restricted”
    Body: “This token uses a permanent delegate. Only the delegate wallet can transfer it.”
  - Do NOT proceed

C) Fix the incorrect “Insufficient SOL” error mapping
Right now transfer failure is being mapped to “Insufficient SOL” incorrectly.
Update error handling so:
1) Only show “Insufficient SOL for Fees” when:
   - actual error/log contains “insufficient funds”
   - OR simulation indicates payer balance < required lamports
2) If the transaction fails with a token restriction / token-2022 program error:
   - show the non-transferable / restricted message instead
3) As a fallback:
   - show a generic themed error: “Transaction failed” + a short reason (no scary raw stack traces)

Do this robustly:
- If you already simulate the tx (connection.simulateTransaction), parse logs:
  - if logs mention token-2022 restriction / non-transferable / permanent delegate / owner not allowed => map to our restriction modal
- If you don’t simulate today, add a lightweight simulation before sending ONLY for Solana sends:
  - simulate, if it fails, map the error to the correct UI message, and do not call sendRawTransaction

D) Themed modal instead of default Alert
Replace the default iOS Alert-looking popup for:
- “Insufficient SOL for Fees”
- “Transaction failed”
with our themed modal component (use whatever the app already uses for themed sheets/modals — e.g. BottomSheet, ThemedModal, or the same component used by Wallet Firewall).
Requirements:
- Dark glassy container, same radius/shadows as other Cordon modals
- Buttons match our primary/secondary style
- No platform default Alert UI

E) Wallet Firewall content update (for DIAS)
When “Review Transaction” opens Wallet Firewall for DIAS, it must show a clear banner if non-transferable/restricted:
- Add a warning card above “Transaction Summary”:
  - “Non-transferable token” or “Permanent delegate restriction”
  - This should come from the same getMintTransferRules() output so the UI is consistent.

Acceptance criteria (must verify):
1) Attempting to send DIAS from a normal holder wallet:
   - User sees a clear “non-transferable / restricted” message BEFORE signing
   - No “Insufficient SOL” message unless truly insufficient
2) If SOL is present, we never show the SOL error for DIAS restriction failures
3) The error popups are fully themed (no default Alert)
4) Other normal SPL tokens (SOL, ROACHY, USDC) still send as before

Deliverables:
- Implement the new helper file
- Wire it into the send flow + wallet firewall UI
- Update error mapping and replace Alert with themed modal
- Add minimal console logs (dev-only) for rules detection (mint, program, flags) so we can debug quickly

Start now by locating the “Insufficient SOL for Fees” string, identify where it’s thrown, then implement the changes above with minimal disruption.